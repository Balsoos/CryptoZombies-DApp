<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoZombies - Blockchain NFT Game</title>
  <link rel="icon" href="favicon.ico">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    h1 {
      font-size: 3em;
      background: linear-gradient(90deg, #00d4ff, #ff00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
      margin-bottom: 10px;
    }

    .subtitle {
      color: #00d4ff;
      font-size: 1.1em;
    }

    #txStatus {
      text-align: center;
      padding: 15px;
      margin: 20px 0;
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      border-radius: 10px;
      font-weight: bold;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 30px;
    }

    button {
      padding: 15px 30px;
      font-size: 1.1em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    .loadZombiesButton:hover {
      transform: none;
      box-shadow: none;
      border-color: rgba(255, 255, 255, 0.3);
      color: rgba(255, 255, 255, 0.8);
    }

    .loadZombiesButton:active {
      transform: none;
    }

    #zombies {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .zombie-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 15px;
      padding: 20px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .zombie-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
      border-color: #00d4ff;
    }

    .zombie-avatar {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4em;
      position: relative;
      overflow: hidden;
    }

    .zombie-avatar::before {
      content: 'üßü';
      font-size: 80px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    .zombie-info {
      list-style: none;
    }

    .zombie-info li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .zombie-info li:last-child {
      border-bottom: none;
    }

    .label {
      font-weight: bold;
      color: #00d4ff;
    }

    .stats {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .stat-box {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: rgba(0, 212, 255, 0.1);
      border-radius: 8px;
      border: 1px solid #00d4ff;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #00d4ff;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
      font-size: 1.2em;
    }

    .empty-state::before {
      content: 'üßü‚Äç‚ôÇÔ∏è';
      display: block;
      font-size: 80px;
      margin-bottom: 20px;
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      }

      50% {
        box-shadow: 0 0 40px rgba(0, 212, 255, 0.8);
      }
    }

    .connected {
      background: rgba(0, 255, 0, 0.1);
      border-color: #00ff00;
      animation: glow 2s ease-in-out infinite;
    }
  </style>

  <script language="javascript" type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script language="javascript" type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
  <script language="javascript" type="text/javascript" src="cryptozombies_abi.js"></script>
</head>

<body>
  <div class="container">
    <header>
      <h1>CryptoZombies</h1>
      <p class="subtitle">üéÆ Collect, Battle & Evolve Your Zombie Army üßü</p>
    </header>

    <div id="txStatus">Connect your MetaMask wallet to begin...</div>

    <div class="controls">
      <button class="showZombieButton">üëÅÔ∏è Show My Zombies</button>
      <button class="createzombieButton">‚ö° Create Zombie</button>
      <button class="levelupButton">‚¨ÜÔ∏è Level Up</button>
    </div>

    <div id="zombieList" style="margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; display: none;">
      <h3 style="color: #00d4ff; margin-bottom: 15px;">My Zombie List</h3>
      <ul id="zombieListItems" style="list-style: none; padding: 0;"></ul>
    </div>

    <div id="zombies"></div>

    <div style="text-align: center; margin-top: 30px; padding: 20px;">
      <button class="loadZombiesButton" style="
        padding: 6px 12px;
        font-size: 0.85em;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        color: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        transition: all 0.2s ease;
      ">Refresh List</button>
    </div>
  </div>

  <script>
    var cryptoZombies;
    var userAccount;
    const showZombieButton = document.querySelector('.showZombieButton');
    const createzombieButton = document.querySelector('.createzombieButton');
    const levelupButton = document.querySelector('.levelupButton');
    const loadZombiesButton = document.querySelector('.loadZombiesButton');

    // Function to load contract address from deployment info
    async function loadContractAddress() {
      try {
        const response = await fetch('deployment-info.json?ts=' + Date.now());
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        const data = await response.json();
        return data.contractAddress;
      } catch (error) {
        console.error('Failed to load deployment info:', error);
        return null;
      }
    }

    async function startApp() {
      // Try to load contract address dynamically
      const contractAddress = await loadContractAddress();

      if (!contractAddress) {
        $("#txStatus").html("Could not find contract address. Make sure Ganache is running and re-run truffle migrate --reset to generate deployment-info.json at the project root.");
        return;
      }

      console.log('Using contract address:', contractAddress);

      // Network/chain check
      const chainId = await web3.eth.getChainId();
      const chainIdHex = '0x' + chainId.toString(16);
      if (chainIdHex !== '0x539') {
        $("#txStatus").html("‚ö†Ô∏è Network mismatch ‚Äî switch MetaMask to Ganache (Chain ID: 1337).");
        $("#txStatus").css('background', 'rgba(255, 193, 7, 0.1)');
        $("#txStatus").css('border-color', '#ffc107');
        return;
      }

      cryptoZombies = new web3.eth.Contract(cryptoZombiesABI, contractAddress);

      // Event listener for transfers
      cryptoZombies.events.Transfer({ filter: { _to: userAccount } })
        .on("data", function (event) {
          let data = event.returnValues;
          getZombiesByOwner(userAccount).then(displayZombies);
        }).on("error", console.error);

      $("#txStatus").html("‚úÖ Connected! Ready to create zombies.");
      $("#txStatus").addClass("connected");
    }

    function displayZombies(ids) {
      $("#zombies").empty();

      if (ids.length === 0) {
        $("#zombies").html('<div class="empty-state">No zombies yet! Create your first one above üßü</div>');
        return;
      }

      for (id of ids) {
        getZombieDetails(id)
          .then(function (zombie) {
            const readyTime = new Date(zombie.readyTime * 1000).toLocaleString();
            const level = zombie.level.toString();
            const wins = zombie.winCount.toString();
            const losses = zombie.lossCount.toString();

            const dnaString = zombie.dna.toString().padStart(16, '0');
            const isReady = zombie.readyTime * 1000 <= Date.now();

            $("#zombies").append(`
              <div class="zombie-card">
                <div class="zombie-avatar" style="background: linear-gradient(135deg, hsl(${parseInt(dnaString.substring(0, 3)) % 360}, 70%, 60%) 0%, hsl(${(parseInt(dnaString.substring(3, 6)) % 360)}, 70%, 50%) 100%);">
                </div>
                <ul class="zombie-info">
                  <li><span class="label">üÜî ID:</span> <span>#${id}</span></li>
                  <li><span class="label">üë§ Name:</span> <span>${zombie.name}</span></li>
                  <li><span class="label">üß¨ DNA:</span> <span>${dnaString}</span></li>
                  <li><span class="label">${isReady ? '‚úÖ' : '‚è∞'}</span> <span>${isReady ? 'Ready' : 'Cooldown'}</span></li>
                </ul>
                <div class="stats">
                  <div class="stat-box">
                    <div class="stat-value">${level}</div>
                    <div>Level</div>
                  </div>
                  <div class="stat-box">
                    <div class="stat-value">${wins}</div>
                    <div>Wins</div>
                  </div>
                  <div class="stat-box">
                    <div class="stat-value">${losses}</div>
                    <div>Losses</div>
                  </div>
                </div>
              </div>
            `);
          });
      }
    }

    function createRandomZombie(name) {
      if (!name || name.trim() === '') {
        name = prompt("Enter a name for your zombie:", "Zombie" + Date.now());
      }

      if (!name || name.trim() === '') {
        $("#txStatus").text("‚ùå Invalid zombie name. Please enter a non-empty name.");
        return;
      }

      // Validate name length (Solidity strings have practical limits)
      if (name.length > 50) {
        $("#txStatus").text("‚ùå Zombie name is too long. Please use 50 characters or less.");
        return;
      }

      $("#txStatus").html("‚è≥ Creating new zombie on the blockchain...<br>This may take a moment...");

      return cryptoZombies.methods.createRandomZombie(name)
        .send({ from: userAccount })
        .on("receipt", function (receipt) {
          $("#txStatus").html(`‚úÖ Successfully created <strong>${name}</strong>!<br>üßü Your zombie is ready for battle!`);
          getZombiesByOwner(userAccount).then(displayZombies);
        })
        .on("error", function (error) {
          let errorMsg = "‚ùå Error creating zombie: ";
          if (error.message.includes("revert")) {
            errorMsg += "Transaction was rejected.";
          } else if (error.message.includes("User denied")) {
            errorMsg += "Transaction was cancelled.";
          } else {
            errorMsg += error.message;
          }
          $("#txStatus").text(errorMsg);
        });
    }

    function feedOnKitty(zombieId, kittyId) {
      $("#txStatus").text("‚è≥ Eating a kitty. This may take a while...");
      return cryptoZombies.methods.feedOnKitty(zombieId, kittyId)
        .send({ from: userAccount })
        .on("receipt", function (receipt) {
          $("#txStatus").html("‚úÖ Ate a kitty and spawned a new Zombie!");
          getZombiesByOwner(userAccount).then(displayZombies);
        })
        .on("error", function (error) {
          $("#txStatus").text("‚ùå " + error.message);
        });
    }

    function levelUp(zombieId) {
      $("#txStatus").text("‚è≥ Leveling up your zombie...");

      return getZombiesByOwner(userAccount).then(function (ids) {
        if (ids.length === 0) {
          $("#txStatus").text("‚ùå You don't have any zombies to level up!");
          return;
        }

        const targetZombieId = zombieId !== undefined ? zombieId : ids[0];

        // Check user's balance before attempting transaction
        return web3.eth.getBalance(userAccount).then(function(balance) {
          const requiredAmount = web3.utils.toWei("0.001", "ether");
          if (web3.utils.toBN(balance).lt(web3.utils.toBN(requiredAmount))) {
            $("#txStatus").text("‚ùå Insufficient balance! You need at least 0.001 ETH to level up.");
            return;
          }

        return cryptoZombies.methods.levelUp(targetZombieId)
            .send({ from: userAccount, value: requiredAmount })
          .on("receipt", function (receipt) {
            $("#txStatus").html("‚úÖ Power overwhelming! Zombie successfully leveled up! üöÄ");
            getZombiesByOwner(userAccount).then(displayZombies);
          })
          .on("error", function (error) {
              let errorMsg = "‚ùå Error leveling up: ";
              if (error.message.includes("revert")) {
                errorMsg += "Transaction failed. Make sure you have enough ETH (0.001 ETH required).";
              } else if (error.message.includes("User denied")) {
                errorMsg += "Transaction was cancelled.";
              } else {
                errorMsg += error.message;
              }
              $("#txStatus").text(errorMsg);
            });
          });
      });
    }

    function getZombieDetails(id) {
      return cryptoZombies.methods.zombies(id).call();
    }

    function zombieToOwner(id) {
      return cryptoZombies.methods.zombieToOwner(id).call();
    }

    function getZombiesByOwner(owner) {
      return cryptoZombies.methods.getZombiesByOwner(owner).call();
    }

    window.addEventListener('load', async () => {
      if (window.ethereum) {
        try {
          // Request account access
          await ethereum.request({ method: 'eth_requestAccounts' });
          userAccount = (await ethereum.request({ method: 'eth_accounts' }))[0];

          const target = '0x539'; // 1337
          const current = await ethereum.request({ method: 'eth_chainId' });

          if (current !== target) {
            try {
              await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: target }] });
            } catch (e) {
              if (e.code === 4902) {
                await ethereum.request({
                  method: 'wallet_addEthereumChain', params: [{
                    chainId: target,
                    chainName: 'Ganache Local',
                    rpcUrls: ['http://127.0.0.1:7545'],
                    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }
                  }]
                });
              } else {
                throw e;
              }
            }
          }

          console.log('Connected account:', userAccount);
          console.log('ChainId:', await ethereum.request({ method: 'eth_chainId' }));

          window.web3 = new Web3(ethereum);
          startApp();
        } catch (error) {
          $("#txStatus").html("‚ùå User denied account access. Please connect MetaMask.");
        }
      }
      else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);
        // Use async getAccounts for Web3.js v1.x compatibility
        web3.eth.getAccounts().then(function(accounts) {
          userAccount = accounts[0];
        startApp();
        }).catch(function(error) {
          $("#txStatus").html("‚ùå Error getting accounts: " + error.message);
        });
      }
      else {
        $("#txStatus").html("‚ùå Non-Ethereum browser detected.<br>Please install MetaMask!");
      }
    });

    if (window.ethereum) {
      ethereum.on('accountsChanged', (accounts) => {
        window.location.reload();
      });

      ethereum.on('chainChanged', (chainId) => {
        window.location.reload();
      });
    }

    createzombieButton.addEventListener('click', () => {
      const zombieName = prompt("Enter a name for your zombie:", "Zombie" + Math.floor(Math.random() * 1000));
      createRandomZombie(zombieName);
    });

    showZombieButton.addEventListener('click', () => {
      $("#txStatus").text("üìã Loading your zombie army...");
      getZombiesByOwner(userAccount)
        .then(function (ids) {
          if (ids.length === 0) {
            $("#txStatus").text("üì≠ You don't have any zombies yet. Create one!");
          } else {
            $("#txStatus").text(`üìã Found ${ids.length} zombie(s)`);
          }
          return ids;
        })
        .then(displayZombies);
    });

    levelupButton.addEventListener('click', () => {
      levelUp();
    });

    loadZombiesButton.addEventListener('click', async () => {
      if (!userAccount || !cryptoZombies) {
        $("#txStatus").text("‚ùå Please connect your wallet first.");
        return;
      }

      $("#txStatus").text("üìã Loading your zombies...");
      
      try {
        const zombieIds = await cryptoZombies.methods.getZombiesByOwner(userAccount).call();
        
        const zombieListDiv = document.getElementById('zombieList');
        const zombieListItems = document.getElementById('zombieListItems');
        
        zombieListItems.innerHTML = '';
        
        if (zombieIds.length === 0) {
          zombieListItems.innerHTML = '<li style="color: #888; padding: 10px;">No zombies found. Create your first zombie!</li>';
        } else {
          for (let i = 0; i < zombieIds.length; i++) {
            const zombieId = zombieIds[i];
            try {
              const zombie = await cryptoZombies.methods.zombies(zombieId).call();
              const listItem = document.createElement('li');
              listItem.style.cssText = 'padding: 10px; margin: 5px 0; background: rgba(0, 212, 255, 0.1); border-radius: 5px; border-left: 3px solid #00d4ff;';
              listItem.innerHTML = `<strong>ID:</strong> ${zombieId} | <strong>Name:</strong> ${zombie.name} | <strong>Level:</strong> ${zombie.level}`;
              zombieListItems.appendChild(listItem);
            } catch (error) {
              console.error('Error fetching zombie details:', error);
            }
          }
        }
        
        zombieListDiv.style.display = 'block';
        $("#txStatus").text(`‚úÖ Loaded ${zombieIds.length} zombie(s)`);
      } catch (error) {
        $("#txStatus").text("‚ùå Error: " + error.message);
        console.error('Error loading zombies:', error);
      }
    });
  </script>
</body>

</html>